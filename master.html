<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹œí—˜ ì„¤ì • (ê´€ë¦¬ììš©)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      margin: 0;
      padding: 40px 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    h2 {
      margin-bottom: 25px;
      font-size: 24px;
      color: #333;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 600;
      color: #444;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      transition: 0.2s;
    }
    input:focus,
    select:focus {
      border-color: #3f51b5;
      outline: none;
      background-color: #f5faff;
    }
    button {
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    #saveBtn {
      background-color: #4caf50;
      color: white;
    }
    #saveBtn:hover {
      background-color: #43a047;
    }
    #logoutBtn {
      background-color: #f44336;
      color: white;
    }
    #logoutBtn:hover {
      background-color: #d32f2f;
    }
    #toggleExamsBtn {
      background-color: #3f51b5;
      color: white;
    }
    #toggleExamsBtn:hover {
      background-color: #303f9f;
    }
    #examList {
      display: none;
      background-color: #f9f9f9;
      padding: 15px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    #examList ul {
      list-style: none;
      padding-left: 0;
    }
    #examList li {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .deleteBtn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    .deleteBtn:hover {
      background-color: #d32f2f;
    }
    #essayLabel,
    #essayInput,
    #essayAnswerLabel,
    #essayAnswerInput {
      display: none;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteField, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_Tgj8J3mPwfs9EsWvuNROld3T4q5iwY8",
      authDomain: "pullupmain.firebaseapp.com",
      projectId: "pullupmain",
      storageBucket: "pullupmain.appspot.com",
      messagingSenderId: "955555666660",
      appId: "1:955555666660:web:f109e5d2ac1e84b161aaf1",
      measurementId: "G-JHWG8K16C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const studentSelect = document.getElementById("studentSelect");
    const subjectInput = document.getElementById("subjectInput");
    const numQuestionsInput = document.getElementById("numQuestionsInput");
    const answerInput = document.getElementById("answerInput");
    const saveBtn = document.getElementById("saveBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const essayLabel = document.getElementById("essayLabel");
    const essayInput = document.getElementById("essayInput");
    const essayAnswerLabel = document.getElementById("essayAnswerLabel");
    const essayAnswerInput = document.getElementById("essayAnswerInput");
    const toggleExamsBtn = document.getElementById("toggleExamsBtn");
    const examList = document.getElementById("examList");

    const loggedUser = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("role");

    if (!loggedUser || role !== "master") {
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      window.location.href = "index.html";
    }

    async function loadStudents() {
      const usersSnapshot = await getDocs(collection(db, "users"));
      usersSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.role === "student") {
          const option = document.createElement("option");
          option.value = docSnap.id;
          option.textContent = docSnap.id;
          studentSelect.appendChild(option);
        }
      });
    }

    loadStudents();

    subjectInput.addEventListener("input", () => {
      const subject = subjectInput.value.trim();
      const showEssay = subject === "ìˆ˜í•™";
      [essayLabel, essayInput, essayAnswerLabel, essayAnswerInput].forEach(el => {
        el.style.display = showEssay ? "block" : "none";
      });
      if (!showEssay) {
        essayInput.value = "";
        essayAnswerInput.value = "";
      }
    });

    saveBtn.addEventListener("click", async () => {
      const studentId = studentSelect.value;
      const subject = subjectInput.value.trim();
      const numQuestions = Number(numQuestionsInput.value);
      const answer = answerInput.value.trim();
      const essayCount = subject === "ìˆ˜í•™" ? Number(essayInput.value || "0") : 0;
      const essayAnswersRaw = subject === "ìˆ˜í•™" ? essayAnswerInput.value.trim() : "";

      if (!studentId || !subject || !numQuestions || !answer) {
        alert("í•™ìƒ, ê³¼ëª©ëª…, ê°ê´€ì‹ ë¬¸í•­ ìˆ˜ ë° ë‹µì•ˆì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (answer.length !== numQuestions) {
        alert(`ê°ê´€ì‹ ë‹µì•ˆ ê¸¸ì´ê°€ ê°ê´€ì‹ ë¬¸í•­ ìˆ˜(${numQuestions})ì™€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        return;
      }

      let essayAnswers = [];
      if (subject === "ìˆ˜í•™") {
        if (essayCount < 0 || isNaN(essayCount)) {
          alert("ì„œìˆ í˜• ë¬¸í•­ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        if (essayCount > 0) {
          if (!essayAnswersRaw) {
            alert("ì„œìˆ í˜• ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }
          essayAnswers = essayAnswersRaw.split(",").map(x => x.trim()).filter(x => x.length > 0);
          if (essayAnswers.length !== essayCount) {
            alert(`ì„œìˆ í˜• ë‹µì•ˆ ê°œìˆ˜(${essayAnswers.length})ê°€ ì„œìˆ í˜• ë¬¸í•­ ìˆ˜(${essayCount})ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
            return;
          }
        }
      }

      const examDocRef = doc(db, "exams", studentId);
      let examData = {};
      try {
        const docSnap = await getDoc(examDocRef);
        if (docSnap.exists()) {
          examData = docSnap.data();
        }
      } catch (e) {
        console.error(e);
      }

      examData[subject] = {
        ê°ê´€ì‹_ë‹µì•ˆ: answer,
        ê°ê´€ì‹_ë¬¸í•­ìˆ˜: numQuestions,
        ì„œìˆ í˜•_ë¬¸í•­ìˆ˜: essayCount,
        ì„œìˆ í˜•_ë‹µì•ˆ: essayAnswers
      };

      await setDoc(examDocRef, examData);
      
      

      alert("ì‹œí—˜ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    // ì‹œí—˜ ëª©ë¡ì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ ë° ì‚­ì œ í•¨ìˆ˜ êµ¬í˜„
    toggleExamsBtn.addEventListener("click", async () => {
      const studentId = studentSelect.value;
      if (!studentId) {
        alert("í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const examDocRef = doc(db, "exams", studentId);
      const docSnap = await getDoc(examDocRef);

      if (examList.style.display === "block") {
        examList.style.display = "none";
        toggleExamsBtn.textContent = "ğŸ“‹ ì‹œí—˜ ëª©ë¡ ë³´ê¸°";
        examList.innerHTML = "";
        return;
      }

      if (docSnap.exists()) {
        const exams = docSnap.data();
        examList.innerHTML = `<strong>${studentId}ì˜ ì‹œí—˜ ëª©ë¡:</strong><ul>` +
          Object.entries(exams).map(([subject, data]) => {
            return `<li>
              <span><strong>${subject}</strong>: ê°ê´€ì‹ ${data.ê°ê´€ì‹_ë¬¸í•­ìˆ˜}ë¬¸í•­, ì„œìˆ í˜• ${data.ì„œìˆ í˜•_ë¬¸í•­ìˆ˜}ë¬¸í•­</span>
              <button class="deleteBtn" data-subject="${subject}">ì‚­ì œ</button>
            </li>`;
          }).join("") + `</ul>`;

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        examList.querySelectorAll(".deleteBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const subjToDelete = e.target.getAttribute("data-subject");
            if (confirm(`${subjToDelete} ì‹œí—˜ì§€ë¥¼ ì‚­ì œí•˜ì‹œìŠµë‹ˆê¹Œ?`)) {
                   try {
        // exam ì»¬ë ‰ì…˜ ë‚´ ê³¼ëª© í•„ë“œ ì‚­ì œ
        await updateDoc(examDocRef, {
          [subjToDelete]: deleteField()
        });

        // results ì»¬ë ‰ì…˜ ë‚´ studentId ë¬¸ì„œì˜ subjToDelete í•„ë“œ ì‚­ì œ
        const resultsDocRef = doc(db, "results", studentId);
        await updateDoc(resultsDocRef, {
          [subjToDelete]: deleteField()
        });

                alert(`${subjToDelete} ì‹œí—˜ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // ì‹œí—˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                toggleExamsBtn.click();
                toggleExamsBtn.click();
              } catch (err) {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                console.error(err);
              }
            }
          });
        });

        examList.style.display = "block";
        toggleExamsBtn.textContent = "âŒ ì‹œí—˜ ëª©ë¡ ìˆ¨ê¸°ê¸°";
      } else {
        alert("í•´ë‹¹ í•™ìƒì˜ ì‹œí—˜ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("role");
      window.location.href = "index.html";
    });

  </script>
</head>
<body>
  <div class="container">
    <h2>ì‹œí—˜ ì„¤ì • (ê´€ë¦¬ììš©)</h2>

    <label for="studentSelect">í•™ìƒ ì„ íƒ</label>
    <select id="studentSelect" required>
      <option value="">í•™ìƒ ì„ íƒ</option>
    </select>

    <label for="subjectInput">ê³¼ëª©ëª… (ì˜ˆ: êµ­ì–´, ì˜ì–´, ìˆ˜í•™ ë“±)</label>
    <input type="text" id="subjectInput" placeholder="ê³¼ëª©ëª… ì…ë ¥" required />

    <label for="numQuestionsInput">ê°ê´€ì‹ ë¬¸í•­ ìˆ˜</label>
    <input type="number" id="numQuestionsInput" min="1" max="100" placeholder="ê°ê´€ì‹ ë¬¸í•­ ìˆ˜ ì…ë ¥" required />

    <label for="answerInput">ê°ê´€ì‹ ë‹µì•ˆ (ì˜ˆ: 12345)</label>
    <input type="text" id="answerInput" placeholder="ê°ê´€ì‹ ë‹µì•ˆ ì…ë ¥" required />

    <label id="essayLabel" for="essayInput">ì„œìˆ í˜• ë¬¸í•­ ìˆ˜ (ìˆ˜í•™ì¼ ë•Œë§Œ í‘œì‹œ)</label>
    <input type="number" id="essayInput" min="0" max="50" placeholder="ì„œìˆ í˜• ë¬¸í•­ ìˆ˜ ì…ë ¥" />

    <label id="essayAnswerLabel" for="essayAnswerInput">ì„œìˆ í˜• ë‹µì•ˆ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì˜ˆ: ë‹µ1, ë‹µ2, ë‹µ3)</label>
    <input type="text" id="essayAnswerInput" placeholder="ì„œìˆ í˜• ë‹µì•ˆ ì…ë ¥" />

    <button id="saveBtn">ì €ì¥í•˜ê¸°</button>
    <button id="toggleExamsBtn">ğŸ“‹ ì‹œí—˜ ëª©ë¡ ë³´ê¸°</button>
    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>

    <div id="examList"></div>
  </div>
</body>
</html>
