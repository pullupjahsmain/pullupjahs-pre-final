<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹œí—˜ ì„¤ì • (ê´€ë¦¬ììš©)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      margin: 0;
      padding: 40px 20px;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h2 {
      margin-bottom: 25px;
      font-size: 24px;
      color: #333;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 600;
      color: #444;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      transition: 0.2s;
    }

    input:focus,
    select:focus {
      border-color: #3f51b5;
      outline: none;
      background-color: #f5faff;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    #saveBtn {
      background-color: #4caf50;
      color: white;
    }

    #saveBtn:hover {
      background-color: #43a047;
    }

    #logoutBtn {
      background-color: #f44336;
      color: white;
      margin-top: 15px;
    }

    #logoutBtn:hover {
      background-color: #d32f2f;
    }

    #essayLabel,
    #essayInput,
    #essayAnswerLabel,
    #essayAnswerInput {
      display: none;
    }

    @media screen and (max-width: 480px) {
      .container {
        padding: 20px;
      }
      h2 {
        font-size: 20px;
      }
    }
  </style>

  <!-- Firebase ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_Tgj8J3mPwfs9EsWvuNROld3T4q5iwY8",
      authDomain: "pullupmain.firebaseapp.com",
      projectId: "pullupmain",
      storageBucket: "pullupmain.appspot.com",
      messagingSenderId: "955555666660",
      appId: "1:955555666660:web:f109e5d2ac1e84b161aaf1",
      measurementId: "G-JHWG8K16C"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loggedUser = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("role");

    if (!loggedUser || role !== "master") {
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      window.location.href = "index.html";
    }

    const studentSelect = document.getElementById("studentSelect");
    const subjectInput = document.getElementById("subjectInput");
    const numQuestionsInput = document.getElementById("numQuestionsInput");
    const answerInput = document.getElementById("answerInput");
    const saveBtn = document.getElementById("saveBtn");
    const essayLabel = document.getElementById("essayLabel");
    const essayInput = document.getElementById("essayInput");
    const essayAnswerLabel = document.getElementById("essayAnswerLabel");
    const essayAnswerInput = document.getElementById("essayAnswerInput");

    async function loadStudents() {
      const usersSnapshot = await getDocs(collection(db, "users"));
      usersSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.role === "student") {
          const option = document.createElement("option");
          option.value = docSnap.id;
          option.textContent = docSnap.id;
          studentSelect.appendChild(option);
        }
      });
    }

    loadStudents();

    subjectInput.addEventListener("input", () => {
      const subject = subjectInput.value.trim();
      const showEssay = subject === "ìˆ˜í•™";
      [essayLabel, essayInput, essayAnswerLabel, essayAnswerInput].forEach(el => {
        el.style.display = showEssay ? "block" : "none";
      });
      if (!showEssay) {
        essayInput.value = "";
        essayAnswerInput.value = "";
      }
    });

    saveBtn.addEventListener("click", async () => {
      const studentId = studentSelect.value;
      const subject = subjectInput.value.trim();
      const numQuestions = Number(numQuestionsInput.value);
      const answer = answerInput.value.trim();
      const essayCount = subject === "ìˆ˜í•™" ? Number(essayInput.value || "0") : 0;
      const essayAnswersRaw = subject === "ìˆ˜í•™" ? essayAnswerInput.value.trim() : "";

      if (!studentId || !subject || !numQuestions || !answer) {
        alert("í•™ìƒ, ê³¼ëª©ëª…, ê°ê´€ì‹ ë¬¸í•­ ìˆ˜ ë° ë‹µì•ˆì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (answer.length !== numQuestions) {
        alert(`ê°ê´€ì‹ ë‹µì•ˆ ê¸¸ì´ê°€ ê°ê´€ì‹ ë¬¸í•­ ìˆ˜(${numQuestions})ì™€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        return;
      }

      let essayAnswers = [];
      if (subject === "ìˆ˜í•™") {
        if (essayCount < 0 || isNaN(essayCount)) {
          alert("ì„œìˆ í˜• ë¬¸í•­ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        if (essayCount > 0) {
          if (!essayAnswersRaw) {
            alert("ì„œìˆ í˜• ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }
          essayAnswers = essayAnswersRaw.split(",").map(x => x.trim()).filter(x => x.length > 0);
          if (essayAnswers.length !== essayCount) {
            alert(`ì„œìˆ í˜• ë‹µì•ˆ ê°œìˆ˜(${essayAnswers.length})ê°€ ì„œìˆ í˜• ë¬¸í•­ ìˆ˜(${essayCount})ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
            return;
          }
        }
      }

      const examDocRef = doc(db, "exams", studentId);
      let examData = {};
      try {
        const docSnap = await getDoc(examDocRef);
        if (docSnap.exists()) {
          examData = docSnap.data();
        }
      } catch (e) {
        console.error(e);
      }

      examData[subject] = {
        ê°ê´€ì‹_ë‹µì•ˆ: answer,
        ê°ê´€ì‹_ë¬¸í•­ìˆ˜: numQuestions,
        ì„œìˆ í˜•_ë¬¸í•­ìˆ˜: essayCount,
        ì„œìˆ í˜•_ë‹µì•ˆ: essayAnswers
      };

      await setDoc(examDocRef, examData);
      await addDoc(collection(db, "results"), {
        studentId,
        subject,
        result: "ë¯¸ì‘ì‹œ",
        timestamp: serverTimestamp()
      });

      alert("ì‹œí—˜ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    function logout() {
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("role");
      window.location.href = "index.html";
    }
  </script>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ ì‹œí—˜ ì„¤ì • (ê´€ë¦¬ì ì „ìš©)</h2>

    <label for="studentSelect">í•™ìƒ ì„ íƒ</label>
    <select id="studentSelect">
      <option value="">-- í•™ìƒ ì„ íƒ --</option>
    </select>

    <label for="subjectInput">ê³¼ëª©ëª… ì…ë ¥</label>
    <input type="text" id="subjectInput" placeholder="ì˜ˆ: ìˆ˜í•™" />

    <label for="numQuestionsInput">ê°ê´€ì‹ ë¬¸í•­ ìˆ˜</label>
    <input type="number" id="numQuestionsInput" placeholder="ì˜ˆ: 5" min="1" max="20" />

    <label id="essayLabel" for="essayInput">ì„œìˆ í˜• ë¬¸í•­ ìˆ˜</label>
    <input type="number" id="essayInput" placeholder="ì˜ˆ: 2" min="0" max="20" />

    <label id="essayAnswerLabel" for="essayAnswerInput">ì„œìˆ í˜• ë‹µì•ˆ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
    <input type="text" id="essayAnswerInput" placeholder="ì˜ˆ: 23,158" />

    <label for="answerInput">ê°ê´€ì‹ ë‹µì•ˆ ì…ë ¥</label>
    <input type="text" id="answerInput" placeholder="ì˜ˆ: 12345" maxlength="20" />

    <button id="saveBtn">ğŸ’¾ ì‹œí—˜ ì„¤ì • ì €ì¥</button>
    <button id="logoutBtn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</body>
</html>
